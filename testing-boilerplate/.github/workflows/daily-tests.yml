# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  DAILY AUTOMATED TESTING â€” GitHub Actions Template           â•‘
# â•‘  Runs all tests daily + on push. Creates GitHub Issue        â•‘
# â•‘  automatically if any test fails.                            â•‘
# â•‘  Adjust steps to match YOUR project's test commands.         â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Daily Health Check

on:
  # â”€â”€ Run daily at 06:00 UTC â”€â”€
  schedule:
    - cron: '0 6 * * *'

  # â”€â”€ Run on every push to main â”€â”€
  push:
    branches: [main]

  # â”€â”€ Allow manual trigger from GitHub UI â”€â”€
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  # Add your project's required env vars here:
  # DATABASE_URL: ${{ secrets.DATABASE_URL }}
  # NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: Type Check + Lint
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  type-check:
    name: Type Check & Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci --legacy-peer-deps

      # TypeScript type checking
      - name: Type Check
        run: npx tsc --noEmit --pretty
        continue-on-error: false

      # ESLint (if configured)
      # - name: Lint
      #   run: npm run lint

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: Unit + Integration Tests
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  unit-tests:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    needs: type-check
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci --legacy-peer-deps

      # Run Vitest with coverage
      - name: Run Tests
        run: npx vitest run --reporter=verbose
        # For coverage: npx vitest run --coverage

      # Upload coverage report (optional)
      # - name: Upload Coverage
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: coverage-report
      #     path: coverage/

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: Health / Smoke Tests
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  health-tests:
    name: Health & Smoke Tests
    runs-on: ubuntu-latest
    needs: type-check
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci --legacy-peer-deps

      - name: Run Health Tests
        run: npx vitest run __tests__/health --reporter=verbose
        # Or if you have a specific script:
        # run: npm run test:health

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 4: Build Check (catches import errors, missing deps)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: [unit-tests, health-tests]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci --legacy-peer-deps

      # Prisma generate (if using Prisma)
      # - run: npx prisma generate

      - name: Build
        run: npm run build
        env:
          # Add build-time env vars if needed:
          # NEXT_PUBLIC_APP_URL: http://localhost:3000
          NODE_ENV: production

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 5: E2E Tests (optional â€” requires running server)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # e2e-tests:
  #   name: E2E Tests
  #   runs-on: ubuntu-latest
  #   needs: build
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-node@v4
  #       with:
  #         node-version: ${{ env.NODE_VERSION }}
  #         cache: 'npm'
  #     - run: npm ci --legacy-peer-deps
  #     - name: Install Playwright
  #       run: npx playwright install --with-deps chromium
  #     - name: Start Server
  #       run: npm run start &
  #       env:
  #         PORT: 3000
  #     - name: Wait for server
  #       run: npx wait-on http://localhost:3000 --timeout 30000
  #     - name: Run E2E Tests
  #       run: npx playwright test
  #       env:
  #         TEST_URL: http://localhost:3000

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 6: Auto-create GitHub Issue on Failure
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  report-failure:
    name: Report Failure
    runs-on: ubuntu-latest
    needs: [type-check, unit-tests, health-tests, build]
    if: failure()
    steps:
      - uses: actions/checkout@v4

      - name: Create Bug Report Issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ğŸ› Daily Tests Failed â€” ${new Date().toISOString().split('T')[0]}`;
            const body = `## Automated Test Failure Report

            **Date:** ${new Date().toISOString()}
            **Branch:** ${context.ref}
            **Commit:** ${context.sha.substring(0, 7)}
            **Trigger:** ${context.eventName}
            **Run:** [View logs](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            ### Failed Jobs
            Check the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details on which tests failed.

            ### Action Required
            1. Check the failing test logs
            2. Identify the root cause
            3. Fix and push a commit
            4. Verify the daily run passes

            ---
            *This issue was created automatically by the Daily Health Check workflow.*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['bug', 'automated-test-failure'],
            });
